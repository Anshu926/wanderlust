<% layout("/layouts/boilerplate.ejs") %>

<body>
  <script>
    const mapToken = "<%= process.env.MAP_TOKEN %>";
    const list = <%- JSON.stringify(list) %>;
  </script>

  <div class="container mt-4">

    <!-- Title -->
    <h2 class="text-center fw-bold mb-5 man"><%= list.title %></h2>

    <!-- IMAGE LEFT + CONTENT RIGHT (Desktop) / STACKED (Mobile) -->
    <div class="row justify-content-center align-items-start">

      <!-- IMAGE SECTION -->
      <div class="col-lg-6 col-md-6 col-12 mb-4">
        <div class="card listing-card">
          <img src="<%= list.image.url %>" class="card-img-top show-img zoom" alt="listing_image">
        </div>
      </div>

      <!-- DETAILS CONTENT SECTION -->
      <div class="col-lg-5 col-md-6 col-12">
        <div class="card p-3">

          <p class="fw-bold mb-2">Owner: <%= list.owner.username %></p>

          <p class="mb-2"><b>Description:</b> <%= list.description %></p>

          <p class="mb-2"><b>Price:</b> â‚¹ <%= list.price.toLocaleString("en-IN") %></p>

          <p class="mb-2"><b>Location:</b> <%= list.location %></p>

          <p class="mb-2"><b>Country:</b> <%= list.country %></p>

          <!-- EDIT + DELETE -->
          <% if (currentUser && list.owner._id.equals(currentUser._id)) { %>
          <div class="d-flex gap-3 mt-3">

            <a href="/listings/<%= list._id %>/edit" class="btn btn-dark">
              <i class="fa-solid fa-pen-to-square"></i>
            </a>

            <form method="POST" action="/listings/<%= list._id %>?_method=DELETE">
              <button class="btn btn-dark">
                <i class="fa-solid fa-trash"></i>
              </button>
            </form>

          </div>
          <% } %>

        </div>
      </div>

    </div> <!-- row end -->

    <!-- REVIEW FORM -->
    <div class="row justify-content-center">
      <div class="col-lg-7 col-md-8 col-12">

        <% if (currentUser) { %>
        <h4 class="mb-3">Leave a Review:</h4>

        <form action="/listings/<%= list.id %>/reviews" method="post" class="needs-validation" novalidate>

          <!-- STAR RATING -->
          <label class="form-label">Rating:</label>
          <fieldset class="starability-slot">
            <input type="radio" id="rate1" name="review[rating]" value="1" checked>
            <label for="rate1">1 star</label>

            <input type="radio" id="rate2" name="review[rating]" value="2">
            <label for="rate2">2 stars</label>

            <input type="radio" id="rate3" name="review[rating]" value="3">
            <label for="rate3">3 stars</label>

            <input type="radio" id="rate4" name="review[rating]" value="4">
            <label for="rate4">4 stars</label>

            <input type="radio" id="rate5" name="review[rating]" value="5">
            <label for="rate5">5 stars</label>
          </fieldset>

          <!-- COMMENT -->
          <div class="mt-3">
            <label class="form-label">Comment:</label>
            <textarea name="review[comment]" class="form-control" rows="4" required></textarea>
            <div class="invalid-feedback">Please provide some comments!</div>
          </div>

          <button class="btn btn-outline-dark mt-3">Submit</button>
        </form>
        <% } %>

      </div>
    </div>

    <!-- ALL REVIEWS -->
    <% if (list.reviews.length > 0) { %>
    <div class="row justify-content-center mt-5">
      <div class="col-lg-10 col-md-10 col-12">

        <hr class="my-4">
        <h4 class="text-center mb-4">All Reviews</h4>

        <div class="row">
          <% for (review of list.reviews) { %>

          <div class="col-lg-6 col-md-6 col-12 mb-3">
            <div class="card review-card">
              <div class="card-body">

                <h5 class="rev-title">By <%= review.author.username %></h5>

                <p class="rev-text"><%= review.comment %></p>

                <p>
                  <b><%= review.rating %></b>
                  <% for (let i = 0; i < review.rating; i++) { %>
                  <i class="fa-solid fa-star fa-sm" style="color: rgb(252, 184, 13);"></i>
                  <% } %>
                </p>

                <form method="POST"
                  action="/listings/<%= list._id %>/reviews/<%= review._id %>?_method=DELETE">
                  <button class="btn btn-dark btn-sm">Delete</button>
                </form>

              </div>
            </div>
          </div>

          <% } %>
        </div>

      </div>
    </div>
    <% } %>

    <!-- MAP SECTION -->
    <div class="row justify-content-center mt-5 mb-5">
      <div class="col-lg-10 col-md-10 col-12">

        <hr class="my-4">
        <h3 class="text-center mb-3">Where you'll be</h3>

        <div id="map" style="width: 100%; height: 350px; border-radius: 10px;"></div>

      </div>
    </div>

  </div> <!-- container end -->

  <script src="/js/map.js"></script>

</body>
